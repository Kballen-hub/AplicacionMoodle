{"version":3,"file":"imageinsert.min.js","sources":["../src/imageinsert.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Tiny media plugin image insertion class for Moodle.\n *\n * @module      tiny_media/imageinsert\n * @copyright   2024 Meirza <meirza.arson@moodle.com>\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Selectors from './selectors';\nimport Dropzone from 'core/dropzone';\nimport uploadFile from 'editor_tiny/uploader';\nimport {prefetchStrings} from 'core/prefetch';\nimport {getStrings} from 'core/str';\nimport {component} from \"./common\";\nimport {getFilePicker} from 'editor_tiny/options';\nimport {displayFilepicker} from 'editor_tiny/utils';\nimport {ImageDetails} from 'tiny_media/imagedetails';\nimport {\n    body,\n    footer,\n    hideElements,\n    showElements,\n    isValidUrl,\n} from './helpers';\nimport {MAX_LENGTH_ALT} from './imagehelpers';\n\nprefetchStrings('tiny_media', [\n    'insertimage',\n    'enterurl',\n    'enterurlor',\n    'imageurlrequired',\n    'uploading',\n    'loading',\n    'addfilesdrop',\n    'sizecustom_help',\n]);\n\nexport class ImageInsert {\n\n    constructor(\n        root,\n        editor,\n        currentModal,\n        canShowFilePicker,\n        canShowDropZone,\n    ) {\n        this.root = root;\n        this.editor = editor;\n        this.currentModal = currentModal;\n        this.canShowFilePicker = canShowFilePicker;\n        this.canShowDropZone = canShowDropZone;\n    }\n\n    init = async function() {\n        // Get the localization lang strings and turn them into object.\n        const langStringKeys = [\n            'insertimage',\n            'enterurl',\n            'enterurlor',\n            'imageurlrequired',\n            'uploading',\n            'loading',\n            'addfilesdrop',\n            'sizecustom_help',\n        ];\n        const langStringvalues = await getStrings([...langStringKeys].map((key) => ({key, component})));\n\n        // Convert array to object.\n        this.langStrings = Object.fromEntries(langStringKeys.map((key, index) => [key, langStringvalues[index]]));\n        this.currentModal.setTitle(this.langStrings.insertimage);\n        if (this.canShowDropZone) {\n            const dropZoneEle = document.querySelector(Selectors.IMAGE.elements.dropzoneContainer);\n\n            // Accepted types can be either a string or an array.\n            let acceptedTypes = getFilePicker(this.editor, 'image').accepted_types;\n            if (Array.isArray(acceptedTypes)) {\n                acceptedTypes = acceptedTypes.join(',');\n            }\n\n            const dropZone = new Dropzone(\n                dropZoneEle,\n                acceptedTypes,\n                files => {\n                    this.handleUploadedFile(files);\n                }\n            );\n            dropZone.setLabel(this.langStrings.addfilesdrop);\n            dropZone.init();\n        }\n        await this.registerEventListeners();\n    };\n\n    /**\n     * Enables or disables the URL-related buttons in the footer based on the current URL and input value.\n     */\n    toggleUrlButton() {\n        const urlInput = this.root.querySelector(Selectors.IMAGE.elements.url);\n        const url = urlInput.value;\n        const addUrl = this.root.querySelector(Selectors.IMAGE.actions.addUrl);\n        addUrl.disabled = !(url !== \"\" && isValidUrl(url));\n    }\n\n    /**\n     * Handles changes in the image URL input field and loads a preview of the image if the URL has changed.\n     */\n    urlChanged() {\n        hideElements(Selectors.IMAGE.elements.urlWarning, this.root);\n        const input = this.root.querySelector(Selectors.IMAGE.elements.url);\n        if (input.value && input.value !== this.currentUrl) {\n            this.loadPreviewImage(input.value);\n        }\n    }\n\n    /**\n     * Loads and displays a preview image based on the provided URL, and handles image loading events.\n     *\n     * @param {string} url - The URL of the image to load and display.\n     */\n    loadPreviewImage = function(url) {\n        this.startImageLoading();\n        this.currentUrl = url;\n        const image = new Image();\n        image.src = url;\n        image.addEventListener('error', () => {\n            const urlWarningLabelEle = this.root.querySelector(Selectors.IMAGE.elements.urlWarning);\n            urlWarningLabelEle.innerHTML = this.langStrings.imageurlrequired;\n            showElements(Selectors.IMAGE.elements.urlWarning, this.root);\n            this.currentUrl = \"\";\n            this.stopImageLoading();\n        });\n\n        image.addEventListener('load', () => {\n            let templateContext = {};\n            templateContext.sizecustomhelpicon = {text: this.langStrings.sizecustom_help};\n            templateContext.bodyTemplate = Selectors.IMAGE.template.body.insertImageDetailsBody;\n            templateContext.footerTemplate = Selectors.IMAGE.template.footer.insertImageDetailsFooter;\n            templateContext.selector = Selectors.IMAGE.type;\n            templateContext.maxlengthalt = MAX_LENGTH_ALT;\n\n            Promise.all([body(templateContext, this.root), footer(templateContext, this.root)])\n                .then(() => {\n                    const imagedetails = new ImageDetails(\n                        this.root,\n                        this.editor,\n                        this.currentModal,\n                        this.canShowFilePicker,\n                        this.canShowDropZone,\n                        this.currentUrl,\n                        image,\n                    );\n                    imagedetails.init();\n                    return;\n                }).then(() => {\n                    this.stopImageLoading();\n                    return;\n                })\n                .catch(error => {\n                    window.console.log(error);\n                });\n        });\n    };\n\n    /**\n     * Displays the upload loader and disables UI elements while loading a file.\n     */\n    startImageLoading() {\n        showElements(Selectors.IMAGE.elements.loaderIcon, this.root);\n        const elementsToHide = [\n            Selectors.IMAGE.elements.insertImage,\n            Selectors.IMAGE.elements.urlWarning,\n            Selectors.IMAGE.elements.modalFooter,\n        ];\n        hideElements(elementsToHide, this.root);\n    }\n\n    /**\n     * Displays the upload loader and disables UI elements while loading a file.\n     */\n    stopImageLoading() {\n        hideElements(Selectors.IMAGE.elements.loaderIcon, this.root);\n        const elementsToShow = [\n            Selectors.IMAGE.elements.insertImage,\n            Selectors.IMAGE.elements.modalFooter,\n        ];\n        showElements(elementsToShow, this.root);\n    }\n\n    filePickerCallback(params) {\n        if (params.url) {\n            this.loadPreviewImage(params.url);\n        }\n    }\n\n    /**\n     * Updates the content of the loader icon.\n     *\n     * @param {HTMLElement} root - The root element containing the loader icon.\n     * @param {object} langStrings - An object containing language strings.\n     * @param {number|null} progress - The progress percentage (optional).\n     * @returns {void}\n     */\n    updateLoaderIcon = (root, langStrings, progress = null) => {\n        const loaderIcon = root.querySelector(Selectors.IMAGE.elements.loaderIconContainer + ' div');\n        loaderIcon.innerHTML = progress !== null ? `${langStrings.uploading} ${Math.round(progress)}%` : langStrings.loading;\n    };\n\n    /**\n     * Handles the uploaded file, initiates the upload process, and updates the UI during the upload.\n     *\n     * @param {FileList} files - The list of files to upload (usually from a file input field).\n     * @returns {Promise<void>} A promise that resolves when the file is uploaded and processed.\n     */\n    handleUploadedFile = async(files) => {\n        try {\n            this.startImageLoading();\n            const fileURL = await uploadFile(this.editor, 'image', files[0], files[0].name, (progress) => {\n                this.updateLoaderIcon(this.root, this.langStrings, progress);\n            });\n            // Set the loader icon content to \"loading\" after the file upload completes.\n            this.updateLoaderIcon(this.root, this.langStrings);\n            this.filePickerCallback({url: fileURL});\n        } catch (error) {\n            // Handle the error.\n            const urlWarningLabelEle = this.root.querySelector(Selectors.IMAGE.elements.urlWarning);\n            urlWarningLabelEle.innerHTML = error.error !== undefined ? error.error : error;\n            showElements(Selectors.IMAGE.elements.urlWarning, this.root);\n            this.stopImageLoading();\n        }\n    };\n\n    registerEventListeners() {\n        this.root.addEventListener('click', async(e) => {\n            const addUrlEle = e.target.closest(Selectors.IMAGE.actions.addUrl);\n            if (addUrlEle) {\n                this.urlChanged();\n            }\n\n            const imageBrowserAction = e.target.closest(Selectors.IMAGE.actions.imageBrowser);\n            if (imageBrowserAction && this.canShowFilePicker) {\n                e.preventDefault();\n                const params = await displayFilepicker(this.editor, 'image');\n                this.filePickerCallback(params);\n            }\n        });\n\n        this.root.addEventListener('input', (e) => {\n            const urlEle = e.target.closest(Selectors.IMAGE.elements.url);\n            if (urlEle) {\n                this.toggleUrlButton();\n            }\n        });\n\n        const fileInput = this.root.querySelector(Selectors.IMAGE.elements.fileInput);\n        if (fileInput) {\n            fileInput.addEventListener('change', () => {\n                this.handleUploadedFile(fileInput.files);\n            });\n        }\n    }\n}\n"],"names":["constructor","root","editor","currentModal","canShowFilePicker","canShowDropZone","init","async","langStringKeys","langStringvalues","map","key","component","langStrings","Object","fromEntries","index","setTitle","this","insertimage","dropZoneEle","document","querySelector","Selectors","IMAGE","elements","dropzoneContainer","acceptedTypes","accepted_types","Array","isArray","join","dropZone","Dropzone","files","handleUploadedFile","setLabel","addfilesdrop","registerEventListeners","toggleUrlButton","url","value","actions","addUrl","disabled","urlChanged","urlWarning","input","currentUrl","loadPreviewImage","startImageLoading","image","Image","src","addEventListener","innerHTML","imageurlrequired","stopImageLoading","templateContext","sizecustomhelpicon","text","sizecustom_help","bodyTemplate","template","body","insertImageDetailsBody","footerTemplate","footer","insertImageDetailsFooter","selector","type","maxlengthalt","MAX_LENGTH_ALT","Promise","all","then","ImageDetails","catch","error","window","console","log","loaderIcon","elementsToHide","insertImage","modalFooter","elementsToShow","filePickerCallback","params","updateLoaderIcon","progress","loaderIconContainer","uploading","Math","round","loading","fileURL","name","undefined","e","target","closest","imageBrowser","preventDefault","fileInput"],"mappings":"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"}